"use strict";(self.webpackChunklearn=self.webpackChunklearn||[]).push([[2720],{385:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/generate-smart-contract-07e92bc1498c4c30405a5837f80c9601.png"},576:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/deploy-1f02eb4c0231dcce3424450db14fdc35.png"},2640:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/execute-ba2554ccb195234464c4567cf966f0fe.png"},2682:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/deploy-response-608ba9d095e7ddf582d7bf0abd9e1af5.png"},4137:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/deploy-signature-d3bb8ab3a7f16aed04122bc5a6c540ab.png"},4889:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/register-call-back-d5087b5a024eb8ed2426f343ceee9392.png"},5137:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/subscribe-6ffaf0eb741d46355d2053ac392b28aa.png"},7172:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"developer-guides/smart-contracts/examples","title":"Example Smart Contracts","description":"Voting Contract","source":"@site/docs/developer-guides/smart-contracts/examples.md","sourceDirName":"developer-guides/smart-contracts","slug":"/developer-guides/smart-contracts/examples","permalink":"/docs/developer-guides/smart-contracts/examples","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Example Smart Contracts","sidebar_label":"Example Smart Contracts"},"sidebar":"docs","previous":{"title":"Write and Deploy a Contract","permalink":"/docs/developer-guides/smart-contracts/write-deploy"},"next":{"title":"What is Xell Wallet?","permalink":"/docs/xell-wallet/what-is-xell"}}');var s=t(4848),i=t(8453);const a={title:"Example Smart Contracts",sidebar_label:"Example Smart Contracts"},o="Example Smart Contracts",c={},l=[{value:"Voting Contract",id:"voting-contract",level:2},{value:"Project Structure",id:"project-structure",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"1. Clone the Voting Smart Contract",id:"1-clone-the-voting-smart-contract",level:3},{value:"2. Generate WASM &amp; Run Server",id:"2-generate-wasm--run-server",level:3},{value:"3. Generate the Smart Contract",id:"3-generate-the-smart-contract",level:3},{value:"4. Subscribe to Smart Contract",id:"4-subscribe-to-smart-contract",level:3},{value:"5. Register Callback URL",id:"5-register-callback-url",level:3},{value:"6. Deploy the Smart Contract",id:"6-deploy-the-smart-contract",level:3},{value:"7. Execute the Smart Contract",id:"7-execute-the-smart-contract",level:3},{value:"8. Display Smart Contract Chain Data",id:"8-display-smart-contract-chain-data",level:3},{value:"Explanation of Voting contract",id:"explanation-of-voting-contract",level:2},{value:"Host Functions",id:"host-functions",level:2},{value:"Contract Logic (<code>lib.rs</code>)",id:"contract-logic-librs",level:2},{value:"Structs &amp; Helpers",id:"structs--helpers",level:3},{value:"Vote Storage Helper",id:"vote-storage-helper",level:3},{value:"Core Functions",id:"core-functions",level:3},{value:"<code>cast_and_tally</code>",id:"cast_and_tally",level:3},{value:"State Management",id:"state-management",level:2},{value:"DApp Server",id:"dapp-server",level:2},{value:"Purpose",id:"purpose",level:2},{value:"Environment Setup",id:"environment-setup",level:2},{value:"Core Logic: <code>main.go</code>",id:"core-logic-maingo",level:2},{value:"1. Import Packages",id:"1-import-packages",level:3},{value:"2. Global Variables",id:"2-global-variables",level:3},{value:"3. Main Function",id:"3-main-function",level:3},{value:"4. Voting Contract Handler",id:"4-voting-contract-handler",level:3},{value:"5. <code>cast_and_tally</code> Logic in Go",id:"5-cast_and_tally-logic-in-go",level:3},{value:"6. WASM Invocation (Default Case)",id:"6-wasm-invocation-default-case",level:3},{value:"Example Input &amp; Output",id:"example-input--output",level:2},{value:"Input",id:"input",level:3},{value:"Output",id:"output",level:3},{value:"Deployment Flow",id:"deployment-flow",level:2},{value:"Security Checks",id:"security-checks",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"example-smart-contracts",children:"Example Smart Contracts"})}),"\n",(0,s.jsx)(n.h2,{id:"voting-contract",children:"Voting Contract"}),"\n",(0,s.jsxs)(n.p,{children:["This contract allows users to ",(0,s.jsx)(n.strong,{children:"register a color"}),", ",(0,s.jsx)(n.strong,{children:"vote"})," for one, and ",(0,s.jsx)(n.strong,{children:"retrieve the winning color"}),". It's written in ",(0,s.jsx)(n.strong,{children:"Rust"}),", compiled to ",(0,s.jsx)(n.strong,{children:"WASM"}),", and deployed on the ",(0,s.jsx)(n.strong,{children:"Rubix blockchain"}),"."]}),"\n",(0,s.jsx)(n.h1,{id:"smart-contract-setup-steps-for-voting-contract",children:"Smart Contract Setup Steps for Voting Contract"}),"\n",(0,s.jsx)(n.h2,{id:"project-structure",children:"Project Structure"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"voting_contract/                              # Rust smart contract\n\u2502\u2500\u2500 Cargo.toml                                # Rust config\n\u2502\u2500\u2500 src/\n\u2502    \u2514\u2500\u2500 lib.rs                               # Contract code\n\u2502\n\u251c\u2500\u2500 dapp_server/                              # Go DApp server\n\u2502   \u251c\u2500\u2500 main.go                               # Entry point for DApp server\n\u2502   \u2514\u2500\u2500 go.mod / go.sum                       # Go module files\n\u2502\n\u2514\u2500\u2500 artifacts/\n     \u2514\u2500\u2500 voting_contract.wasm                 \n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Rust (with ",(0,s.jsx)(n.code,{children:"wasm32-unknown-unknown"})," target)"]}),"\n",(0,s.jsx)(n.li,{children:"Go (to run the DApp server)"}),"\n",(0,s.jsx)(n.li,{children:"Rubix Node"}),"\n",(0,s.jsx)(n.li,{children:"DIDs created on the node."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"1-clone-the-voting-smart-contract",children:"1. Clone the Voting Smart Contract"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/rubixchain/rubix-dapps\ncd contracts\ncd voting-contract\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-generate-wasm--run-server",children:"2. Generate WASM & Run Server"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd voting-contract\ncargo build --target wasm32-unknown-unknown\n"})}),"\n",(0,s.jsx)(n.p,{children:"The WASM file will be generated at:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"target/wasm32-unknown-unknown/debug/voting_contract.wasm\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Create a folder ",(0,s.jsx)(n.code,{children:"artifacts"})," and copy the wasm file into it."]}),"\n",(0,s.jsx)(n.p,{children:"To run the DApp server:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"go run main.go\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"3-generate-the-smart-contract",children:"3. Generate the Smart Contract"}),"\n",(0,s.jsxs)(n.p,{children:["Open Swagger at: ",(0,s.jsx)(n.code,{children:"http://localhost:<port at which rubix node is running>/swagger/index.html"})]}),"\n",(0,s.jsxs)(n.p,{children:["From the deployer node, we will generate the contract using ",(0,s.jsx)(n.code,{children:"/api/genarate-smart-contract"})," . It has 4 params:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"did"})," : Provide the Deployer DID"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"binaryCodePath"})," :  Upload WASM contract here"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"rawCodePath"})," : Upload the contract source code file (",(0,s.jsx)(n.code,{children:"voting_contract/src/lib.rs"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"schemaFilePath"})," : Upload the Schema File Path (",(0,s.jsx)(n.code,{children:"store_state/vote_contract/votefile.json"}),")"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Generate smart contract",src:t(385).A+"",width:"1429",height:"713"})}),"\n",(0,s.jsxs)(n.p,{children:["Get the contract tokenID from the output (example: ",(0,s.jsx)(n.code,{children:"QmXyz..."}),")"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," For all the following steps you can use either swagger or CLI."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"4-subscribe-to-smart-contract",children:"4. Subscribe to Smart Contract"}),"\n",(0,s.jsx)(n.p,{children:"In Rubix\u2019s stateless, event-driven architecture, not all nodes are aware of every smart contract by default. To participate in or track the execution of a specific contract, a node must explicitly subscribe to it. This subscription uses a publish-subscribe (pub-sub) mechanism that ensures only interested nodes receive updates or execution events related to the contract. By subscribing, a node signals that it wants to stay in sync with the contract\u2019s state transitions and be notified when actions like execution or deployment occur. Without subscribing, a node would remain unaware of these updates, as Rubix does not broadcast all contract activity globally like traditional blockchains."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Subscribe smart contract",src:t(5137).A+"",width:"1426",height:"797"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -X POST http://localhost:20000/api/subscribe-smart-contract \\\n-H 'Content-Type: application/json' \\\n-d '{\"smartContractToken\": \"<Smart Contract Token Hash>\"}'\n"})}),"\n",(0,s.jsx)(n.h3,{id:"5-register-callback-url",children:"5. Register Callback URL"}),"\n",(0,s.jsx)(n.p,{children:"Since Rubix is designed to be stateless, it ensures that the blockchain itself does not bear the computational or storage load of executing smart contract logic."}),"\n",(0,s.jsxs)(n.p,{children:["To facilitate this, when a smart contract is executed via the Rubix node, the node sends a POST request to a Callback URL registered by the developer or user. This URL typically points to a server (e.g., ",(0,s.jsx)(n.code,{children:"http://localhost:8080/api/contract-input"}),") which:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Receives the smart contract execution request."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Loads the corresponding WASM file."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Calls the appropriate function inside the WASM using a compatible runtime."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Reads/writes to external state (like JSON, databases, or other storage)."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Register callback",src:t(4889).A+"",width:"1426",height:"796"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:20000/api/register-callback-url \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "CallBackURL": "http://localhost:8080/api/v1-contract-input",\n  "SmartContractToken": "<Smart Contract TokenID>"\n}\'\n'})}),"\n",(0,s.jsx)(n.h3,{id:"6-deploy-the-smart-contract",children:"6. Deploy the Smart Contract"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"We will now proceed to deploy the contract from the Deployer node and commit 1 RBT to it:"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Deploy smart contract",src:t(576).A+"",width:"1430",height:"650"})}),"\n",(0,s.jsx)(n.p,{children:"-you will get response with an ID, use it to do the signature."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Deploy response",src:t(2682).A+"",width:"1426",height:"803"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"confirm deployment of the smart contract by doing the signature"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Signature",src:t(4137).A+"",width:"1424",height:"806"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'\n```bash\ncurl -X POST http://localhost:20000/api/deploy-smart-contract \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "comment": "deploying..",\n  "deployerAddr": "<Deployer DID>",\n  "quorumType": <Type of the quorum>,\n  "rbtAmount": <RBT amount to deploy the contract>,\n  "smartContractToken": "<Smart Contract TokenID>"\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"Then, confirm using:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:20000/api/signature-response \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "id": "<UUID from deploy response>",\n  "mode": 0,\n  "password": "mypassword"\n}\'\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"7-execute-the-smart-contract",children:"7. Execute the Smart Contract"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:'we can now proceed to execute the contract with "Red" as a vote.'}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Execute smart contract",src:t(2640).A+"",width:"1401",height:"802"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"similar to deployment of the smart contract, use the output of the execute smart contract to go ahead with the signature response."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:20000/api/execute-smart-contract \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "comment": "executing..",\n  "executorAddr": "<Executor DID>",\n  "quorumType": 2,\n  "smartContractData": "Red",\n  "smartContractToken": "<Smart Contract TokenID>"\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"Then, confirm using:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:20000/api/signature-response \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "id": "<UUID from execute response>",\n  "mode": 0,\n  "password": "mypassword"\n}\'\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"8-display-smart-contract-chain-data",children:"8. Display Smart Contract Chain Data"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Full Chain:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:20000/api/get-smart-contract-token-chain-data \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "latest": false,\n  "token": "<Smart Contract TokenID>"\n}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Latest Block:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:20000/api/get-smart-contract-token-chain-data \\\n-H \'Content-Type: application/json\' \\\n-d \'{\n  "latest": true,\n  "token": "<Smart Contract TokenID>"\n}\'\n'})}),"\n",(0,s.jsx)(n.h2,{id:"explanation-of-voting-contract",children:"Explanation of Voting contract"}),"\n",(0,s.jsx)(n.h2,{id:"host-functions",children:"Host Functions"}),"\n",(0,s.jsx)(n.p,{children:"Rubix smart contracts are compiled into WebAssembly (WASM) and executed within a secure runtime. However, since WASM modules are sandboxed by design, they cannot directly perform operations like accessing the network, filesystem, or persistent storage. To bridge this gap, Rubix exposes a set of host functions through its WASM runtime."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'extern "C" {\n    fn read_state(key_ptr: *const u8, key_len: usize, val_ptr: *mut u8, val_len: usize) -> i32;\n    fn write_state(key_ptr: *const u8, key_len: usize, val_ptr: *const u8, val_len: usize) -> i32;\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"These are used for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Reading/writing blockchain key-value storage"}),"\n",(0,s.jsx)(n.li,{children:"Transferring tokens (if needed)"}),"\n",(0,s.jsx)(n.li,{children:"Calling external APIs"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h2,{id:"contract-logic-librs",children:["Contract Logic (",(0,s.jsx)(n.code,{children:"lib.rs"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Rubix follows a stateless smart contract model, where the contract itself does not maintain or store state on-chain. Instead, all inputs and stateful data are handled off-chain through external resources such as files (JSON, CSV), databases (like SQLite or NoSQL), or even decentralized storage like IPFS. To interface with these external sources, Rubix uses host functions, which act as bridges between the contract logic and the external state."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"structs--helpers",children:"Structs & Helpers"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"#[derive(Serialize, Deserialize, Debug)]\npub struct ContractResponse {\n    pub msg: String,\n}\n\n#[derive(Serialize, Deserialize, Debug)]\npub struct ContractError {\n    pub msg: String,\n}\n\n#[derive(Serialize, Deserialize, Clone, Debug)]\npub struct Vote {\n    pub voter_id: String,\n    pub color: String,\n}\n\n#[derive(Serialize, Deserialize, Debug)]\npub struct CastAndTally {\n    pub voter_id: String,\n    pub color: String,\n}\n\nstatic mut VOTES: Option<Vec<Vote>> = None;\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ContractResponse"})," and ",(0,s.jsx)(n.code,{children:"ContractError"})," are used to serialize success or error messages."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"Vote"})," stores a single voter\u2019s choice."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"CastAndTally"})," is the struct used for deserializing inputs to the ",(0,s.jsx)(n.code,{children:"cast_and_tally"})," function."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"VOTES"})," stores the in-memory list of all vote entries globally."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"vote-storage-helper",children:"Vote Storage Helper"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"fn get_votes() -> &'static mut Vec<Vote> {\n    unsafe {\n        if VOTES.is_none() {\n            VOTES = Some(Vec::new());\n        }\n        VOTES.as_mut().unwrap()\n    }\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Lazily initializes the in-memory vote store when first accessed."}),"\n",(0,s.jsx)(n.li,{children:"Ensures votes are accumulated across multiple calls during runtime."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"core-functions",children:"Core Functions"}),"\n",(0,s.jsx)(n.h3,{id:"cast_and_tally",children:(0,s.jsx)(n.code,{children:"cast_and_tally"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'#[contract_fn]\npub fn cast_and_tally(input: CastAndTally) -> Result<String, ContractError> {\n    if !ALLOWED_COLORS.contains(&input.color.as_str()) {\n        return Err(ContractError::new("Invalid color"));\n    }\n\n    let votes = get_votes();\n    votes.push(Vote {\n        voter_id: input.voter_id.clone(),\n        color: input.color.clone(),\n    });\n\n    let mut color_counts: HashMap<String, usize> = HashMap::new();\n    for vote in votes.iter() {\n        *color_counts.entry(vote.color.clone()).or_insert(0) += 1;\n    }\n\n    let winner = color_counts\n        .iter()\n        .max_by_key(|entry| entry.1)\n        .map(|(color, _)| color.clone())\n        .unwrap_or_else(|| "No votes yet".to_string());\n\n    let msg = format!(\n        "Vote cast for \'{}\'. Tally: {:?}. Winner: {}",\n        input.color, color_counts, winner\n    );\n\n    let response = ContractResponse { msg };\n    serde_json::to_string(&response)\n        .map_err(|e| ContractError::new(&format!("Serialization error: {}", e)))\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Validates if the provided color is allowed (",(0,s.jsx)(n.code,{children:"Red"}),", ",(0,s.jsx)(n.code,{children:"Green"}),", ",(0,s.jsx)(n.code,{children:"Blue"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Adds the vote to the internal memory store."}),"\n",(0,s.jsx)(n.li,{children:"Tallies votes across all colors using a HashMap."}),"\n",(0,s.jsx)(n.li,{children:"Calculates the color with the maximum number of votes and includes it in the output."}),"\n",(0,s.jsx)(n.li,{children:"Returns the result as a serialized JSON message."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"state-management",children:"State Management"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Votes are stored in memory via a lazily initialized global static variable (",(0,s.jsx)(n.code,{children:"VOTES"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"State is retained across multiple function calls during a runtime session."}),"\n",(0,s.jsx)(n.li,{children:"The function currently does not prevent duplicate votes or persist them permanently to chain state."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"dapp-server",children:"DApp Server"}),"\n",(0,s.jsxs)(n.p,{children:["This ",(0,s.jsx)(n.strong,{children:"Go-based DApp server"})," acts as the execution environment for the compiled WASM voting contract deployed on the ",(0,s.jsx)(n.strong,{children:"Rubix blockchain"}),". It exposes a REST API to receive smart contract calls via callback, invokes the appropriate contract method, and returns the result."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"purpose",children:"Purpose"}),"\n",(0,s.jsx)(n.p,{children:"The DApp server:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Loads environment variables (Rubix Node URL, WASM file path)."}),"\n",(0,s.jsx)(n.li,{children:"Accepts contract execution inputs over HTTP."}),"\n",(0,s.jsx)(n.li,{children:"Loads and runs the WASM smart contract."}),"\n",(0,s.jsx)(n.li,{children:"Parses the input and returns structured results."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"environment-setup",children:"Environment Setup"}),"\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.code,{children:".env"})," file based on ",(0,s.jsx)(n.code,{children:".env.sample"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-env",children:"RUBIX_NODE_ADDRESS=http://localhost:20009\nVOTING_CONTRACT_PATH=/Users/arnab/TRIE-internal/contracts/voting_contract/artifacts/voting_contract.wasm\n"})}),"\n",(0,s.jsx)(n.p,{children:"Install dependencies:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"go mod tidy\n"})}),"\n",(0,s.jsx)(n.p,{children:"Run the server:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"go run main.go\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h2,{id:"core-logic-maingo",children:["Core Logic: ",(0,s.jsx)(n.code,{children:"main.go"})]}),"\n",(0,s.jsx)(n.h3,{id:"1-import-packages",children:"1. Import Packages"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'import (\n\t"encoding/json"\n\t"fmt"\n\t"net/http"\n\t"os"\n\t"path"\n\t"sync"\n\n\t"github.com/gin-gonic/gin"\n\t"github.com/joho/godotenv"\n\twasmbridge "github.com/rubixchain/rubix-wasm/go-wasm-bridge"\n)\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"godotenv"}),": loads ",(0,s.jsx)(n.code,{children:".env"})," file."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"wasmbridge"}),": interfaces with Rubix WASM runtime."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"sync"}),": protects in-memory vote storage."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-global-variables",children:"2. Global Variables"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"var (\n\tvoteStore = make(map[string]string)\n\tstoreLock = sync.Mutex{}\n)\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A thread-safe in-memory map to track votes."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-main-function",children:"3. Main Function"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func main() {\n\t_ = godotenv.Load() // Load .env\n\tr := gin.Default()\n\tr.POST("/api/voting-contract", handleVotingContract)\n\tr.Run(":8080")\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Exposes one POST endpoint."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"4-voting-contract-handler",children:"4. Voting Contract Handler"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func handleVotingContract(c *gin.Context) {\n\tnodeAddress := os.Getenv("RUBIX_NODE_ADDRESS")\n\tcontractPath := os.Getenv("VOTING_CONTRACT_PATH")\n\n\tvar contractInput struct {\n\t\tMethod  string                 `json:"method"`\n\t\tPayload map[string]interface{} `json:"payload"`\n\t}\n\tif err := c.ShouldBindJSON(&contractInput); err != nil {\n\t\twrapError(c.JSON, "Invalid request body")\n\t\treturn\n\t}\n\n\tswitch contractInput.Method {\n\tcase "cast_and_tally":\n\t\t// Handle directly\n\t\tcastAndTally(contractInput.Payload, c)\n\tdefault:\n\t\t// Fallback to WASM invocation\n\t\tinvokeWasmMethod(nodeAddress, contractPath, contractInput, c)\n\t}\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This function acts as the entry point for all smart contract API requests coming into the DApp server."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Reads the contract execution request (method + payload) from the incoming JSON body."}),"\n",(0,s.jsx)(n.li,{children:"Ensures extensibility: new smart contract methods can be added either as direct Go implementations or via WASM execution without changing the endpoint."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"This separation allows optimization for commonly used functions (direct Go handling) while preserving flexibility for all other contract methods (via WASM runtime)."}),"\n",(0,s.jsxs)(n.h3,{id:"5-cast_and_tally-logic-in-go",children:["5. ",(0,s.jsx)(n.code,{children:"cast_and_tally"})," Logic in Go"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func castAndTally(payload map[string]interface{}, c *gin.Context) {\n\tvoterID := payload["voter_id"].(string)\n\tcolor := payload["color"].(string)\n\n\tstoreLock.Lock()\n\tvoteStore[voterID] = color\n\ttally := make(map[string]int)\n\tfor _, c := range voteStore {\n\t\ttally[c]++\n\t}\n\n\twinner := ""\n\tmaxVotes := -1\n\tfor color, count := range tally {\n\t\tif count > maxVotes {\n\t\t\tmaxVotes = count\n\t\t\twinner = color\n\t\t}\n\t}\n\tstoreLock.Unlock()\n\n\twrapSuccess(c.JSON, fmt.Sprintf("Vote recorded. Tally: %v. Current winner: %s", tally, winner))\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"cast_and_tally"})," function is implemented natively in Go for faster execution and easy debugging."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Vote Recording"})," \u2013 Saves the incoming vote (",(0,s.jsx)(n.code,{children:"voter_id \u2192 color"}),") into an in-memory map (voteStore)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Duplicate Handling"})," \u2013 If a voter casts multiple votes, their latest choice automatically overwrites the old one (ensuring one vote per voter)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Tallying"})," \u2013 Iterates over all votes in the map and counts the number of votes per color."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Winner Calculation"})," \u2013 Finds the color with the maximum votes and marks it as the current winner."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Thread-Safety"})," \u2013 Uses a mutex (",(0,s.jsx)(n.code,{children:"storeLock"}),") to ensure consistency when multiple users vote simultaneously."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"6-wasm-invocation-default-case",children:"6. WASM Invocation (Default Case)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'func invokeWasmMethod(nodeAddr, contractPath string, input struct {\n\tMethod  string\n\tPayload map[string]interface{}\n}, c *gin.Context) {\n\thostFnRegistry := wasmbridge.NewHostFunctionRegistry()\n\twasmModule, err := wasmbridge.NewWasmModule(\n\t\tpath.Clean(contractPath),\n\t\thostFnRegistry,\n\t\twasmbridge.WithRubixNodeAddress(nodeAddr),\n\t)\n\tif err != nil {\n\t\twrapError(c.JSON, fmt.Sprintf("failed to load wasm module: %v", err))\n\t\treturn\n\t}\n\n\tinputBytes, _ := json.Marshal(map[string]interface{}{input.Method: input.Payload})\n\tresult, err := wasmModule.CallFunction(string(inputBytes))\n\tif err != nil {\n\t\twrapError(c.JSON, fmt.Sprintf("contract function call failed: %v", err))\n\t\treturn\n\t}\n\n\tmsg, errMsg := extractContractOutput(result)\n\tif errMsg != "" {\n\t\twrapError(c.JSON, errMsg)\n\t\treturn\n\t}\n\twrapSuccess(c.JSON, msg)\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"When the requested method is not implemented natively in Go, the server falls back to invoking the compiled WASM contract."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Loads the ",(0,s.jsx)(n.code,{children:".wasm"})," file using ",(0,s.jsx)(n.code,{children:"wasmbridge"}),", a Rubix library for executing WASM modules."]}),"\n",(0,s.jsx)(n.li,{children:"Passes the input payload as JSON to the WASM function."}),"\n",(0,s.jsx)(n.li,{children:"Executes the contract logic securely inside the Rubix WASM runtime."}),"\n",(0,s.jsx)(n.li,{children:"Extracts the result from the WASM execution and formats it for the API response.\nThis ensures that all contract logic remains decentralized and verifiable on Rubix, while still allowing selective optimization via Go-native handlers."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"example-input--output",children:"Example Input & Output"}),"\n",(0,s.jsx)(n.h3,{id:"input",children:"Input"}),"\n",(0,s.jsxs)(n.p,{children:["To test the voting contract using the DApp server, open your terminal, navigate to the ",(0,s.jsx)(n.code,{children:"dapp_server"})," folder (which contains the main.go file), and make sure the server is running by running ",(0,s.jsx)(n.code,{children:"go run main.go"})," . Once the server is up and listening on port 8080, use the following curl command in a separate terminal window to send a request:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8080/api/voting-contract \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "method": "cast_and_tally",\n    "payload": {\n      "voter_id": "voter1",\n      "color": "Red"\n    }\n  }\'\n'})}),"\n",(0,s.jsx)(n.h3,{id:"output",children:"Output"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "status": "success",\n  "message": "Vote cast for \'Red\'. Tally: {\\"Red\\": 1}. Winner: Red"\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"deployment-flow",children:"Deployment Flow"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Write logic in ",(0,s.jsx)(n.code,{children:"lib.rs"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Compile using ",(0,s.jsx)(n.code,{children:"cargo build"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Upload ",(0,s.jsx)(n.code,{children:".wasm"})," file to Rubix node."]}),"\n",(0,s.jsx)(n.li,{children:"Trigger function using Rubix CLI or DApp server."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"security-checks",children:"Security Checks"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Prevents double voting by checking ",(0,s.jsx)(n.code,{children:"vote_<user_did>"})," state."]}),"\n",(0,s.jsx)(n.li,{children:"Validates registered colors before allowing vote."}),"\n",(0,s.jsx)(n.li,{children:"Stores all state on-chain using Rubix's persistent storage."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(6540);const s={},i=r.createContext(s);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);